---
    - name: Install and configure software for rpi-kickstart
      gather_facts: True
      hosts: localhost
      connection: local
      tasks:
        - name: Copy iptables rules files
          copy:
             src: files/iptables.rules
             dest: /etc/iptables.rules
             owner: root
             group: root
             mode: 0644
        - name: Apply iptables rules
          command: iptables-restore /etc/iptables.rules
        - name: Update apt repositories
          when: ansible_os_family == "Debian"
          apt:
            update_cache: yes
            cache_valid_time: 86400
        - file:
            path: /tftp
            state: directory
            mode: 0755
            owner: root
            group: root
        - name: Install dnsmasq (deb)
          when: ansible_os_family == "Debian"
          apt:
            name: dnsmasq
            state: latest
        - name: Install dnsmasq (rpm)
          when: ansible_os_family == "RedHat"
          yum:
            name: dnsmasq
            state: latest
        - name: Install nginx (deb)
          when: ansible_os_family == "Debian"
          apt:
            name: nginx
            state: latest
        - name: Install nginx (rpm)
          when: ansible_os_family == "RedHat"
          yum:
            name: nginx
            state: latest
        - name: Install pxelinux (deb)
          when: ansible_os_family == "Debian"
          apt:
            name: pxelinux
            state: latest
        - name: Install pxelinux (rpm)
          when: ansible_os_family == "RedHat"
          yum:
            name: pxelinux
            state: latest
        - name: Enable dnsmasq
          service:
            name: dnsmasq
            enabled: yes
        - name: Populate dnsmasq main configuration file
          copy:
             src: files/dnsmasq.conf
             dest: /etc/dnsmasq.conf
             owner: root
             group: root
             mode: 0644
          notify:
            - Restart dnsmasq
        - name: Enable nginx
          service:
            name: nginx
            enabled: yes
        - name: Symlink PXE dependencies
          when: ansible_os_family == "Debian"
          command: find /usr/lib/syslinux/modules/bios/ -name *.c32 -exec ln -s {}  /tftp/ \;
      handlers:
        - name: Restart dnsmasq
          service:
            name: dnsmasq
            state: restarted
        - name: Restart nginx
          service:
            name: nginx
            state: restarted
    - name: Run Local Playbook
      gather_facts: True
      hosts: localhost
      connection: local
      tasks:
        - local_action: stat path=/root/rpi-kickstart-local.yaml
          register: local_playbook_file
        - include: /root/rpi-kickstart-local.yaml
          when: local_playbook_file.stat.exists
